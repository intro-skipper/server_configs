name: Test Caddy HTTPS Redirects

on:
  push:
  workflow_dispatch:

jobs:
  test-redirects:
    runs-on: ubuntu-latest
    steps:
      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl ca-certificates

      - name: Run HTTPS redirect tests
        shell: bash
        run: |
          set -e

          # Define all target hosts, including IPv6 addresses
          HOSTS=(
            "manifest.intro-skipper.org"
            "165.227.244.161"
            "161.35.245.42"
          )

          # Use domain name for Host header on IPs
          VIRTUAL_HOST="manifest.intro-skipper.org"
          CDN_PREFIX="https://cdn.jsdelivr.net/gh/intro-skipper/manifest@"
          CDN_COMMIT=""

          run_test() {
            HOST=$1
            UA=$2
            PATH=$3
            EXPECTED=$4
            DESC=$5

            echo "::group::[$HOST] $DESC"

            # Use --resolve to bind IPs to the virtual host
            # For IPv6, the address needs to be bracketed in --resolve
            if [[ "$HOST" == "$VIRTUAL_HOST" ]]; then
              RESOLVE_OPT=""
              HOST_HEADER_OPT=""
            else
              if [[ "$HOST" == *":"* ]]; then # Check if HOST is an IPv6 address
                RESOLVE_OPT="--resolve $VIRTUAL_HOST:443:[$HOST]"
              else # Assume HOST is an IPv4 address
                RESOLVE_OPT="--resolve $VIRTUAL_HOST:443:$HOST"
              fi
              HOST_HEADER_OPT="--header Host:$VIRTUAL_HOST"
            fi

            ACTUAL=$(/usr/bin/curl -s -L -o /dev/null -w "%{url_effective}" \
              -A "$UA" \
              $RESOLVE_OPT \
              $HOST_HEADER_OPT \
              --connect-timeout 10 \
              "https://$VIRTUAL_HOST$PATH")

            case "$EXPECTED" in
              cdn:*)
                VERSION="${EXPECTED#cdn:}"
                if [[ "$ACTUAL" =~ ^https://cdn\.jsdelivr\.net/gh/intro-skipper/manifest@([0-9a-f]{40})/$VERSION/manifest\.json$ ]]; then
                  HASH="${BASH_REMATCH[1]}"
                  if [[ -z "$CDN_COMMIT" ]]; then
                    CDN_COMMIT="$HASH"
                  elif [[ "$CDN_COMMIT" != "$HASH" ]]; then
                    echo "❌ FAIL: commit hash mismatch: expected '$CDN_COMMIT', got '$HASH'"
                    exit 1
                  fi
                else
                  echo "❌ FAIL: unexpected CDN URL '$ACTUAL'"
                  exit 1
                fi
                ;;
              literal:*)
                LITERAL="${EXPECTED#literal:}"
                if [[ "$ACTUAL" != "$LITERAL" ]]; then
                  echo "❌ FAIL: expected '$LITERAL', got '$ACTUAL'"
                  exit 1
                fi
                ;;
              *)
                echo "❌ FAIL: unsupported expectation '$EXPECTED'"
                exit 1
                ;;
            esac

            echo "✅ PASS"
            echo "::endgroup::"
          }

          for HOST in "${HOSTS[@]}"; do
            run_test "$HOST" "Jellyfin-Server/10.8.7" "/manifest.json" "cdn:10.8" "10.8 → branch"
            run_test "$HOST" "Jellyfin-Server/10.9.2" "/manifest.json" "cdn:10.9" "10.9 → branch"
            run_test "$HOST" "Jellyfin-Server/10.10.1" "/manifest.json" "cdn:10.10" "10.10 → branch"
            run_test "$HOST" "Jellyfin-Server/10.11.0" "/manifest.json" "cdn:10.11" "10.11 → branch"
            run_test "$HOST" "Jellyfin-Server/10.12.0" "/manifest.json" "cdn:10.11" "Unknown 10.x → fallback"
            run_test "$HOST" "Jellyfin-Server/10.9.2" "/" "literal:https://github.com/intro-skipper/" "Not /manifest.json → GitHub"
            run_test "$HOST" "curl/8.5.0" "/manifest.json" "literal:https://github.com/intro-skipper/" "Non-Jellyfin UA → GitHub"
          done
